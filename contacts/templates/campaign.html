{% extends 'base.html' %}

{% block title %}
    <title>Campaigns</title>
{% endblock %}

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

{% block content %}
    <div class="ml-2">
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="viewCampaignDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                View Campaign
            </button>
            <div class="dropdown-menu" aria-labelledby="viewCampaignDropdown">
                <a class="dropdown-item view-campaign" id="Django Campaign">Django Campaign</a>
                <a class="dropdown-item view-campaign" id="Django Campaign 2">Django Campaign 2</a>
            </div>
        </div>
    </div>

    <div id="campaignContent" class="mt-3">
        {% if selected_campaign %}
            <h2>Leads for {{ selected_campaign.name }}</h2>
            <!-- Display Contacts Table -->
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllCheckbox">
                        </th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Company</th>
                        <th>Title</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="leadTableBody">
                    {% for lead in selected_leads %}
                        <tr class="contact-row" data-id="{{ lead.id }}">
                            <td>
                                <input type="checkbox" class="contact-checkbox" value="{{ lead.id }}">
                            </td>
                            <td>{{ lead.first_name }}</td>
                            <td>{{ lead.last_name }}</td>
                            <td>{{ lead.email }}</td>
                            <td>{{ lead.company }}</td>
                            <td>{{ lead.title }}</td>
                            <td>{{ lead.type }}</td>
                            <td>{{ lead.level }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Please select a campaign to view</p>
        {% endif %}
    </div>

    <script>
        function handleAddToCampaign(campaign) {
            return fetch(`/get_campaign_leads/?campaign=${campaign}`)
                .then(response => response.json())
                .then(data => {
                    let leadsTableHTML = '';
                    if (Array.isArray(data)) {
                        data.forEach(lead => {
                            // Create table rows for each lead
                            leadsTableHTML += `
                                <tr>
                                    <td>${lead.first_name}</td>
                                    <td>${lead.last_name}</td>
                                    <td>${lead.email}</td>
                                    <td>${lead.company}</td>
                                    <td>${lead.title}</td>
                                    <td>${lead.type}</td>
                                </tr>
                            `;
                        });
                    } else if (typeof data === 'object') {
                        // Assuming data is an object with lead information
                        for (const key in data) {
                            if (data.hasOwnProperty(key)) {
                                const lead = data[key];
                                leadsTableHTML += `
                                    <tr>
                                        <td>${lead.first_name}</td>
                                        <td>${lead.last_name}</td>
                                        <td>${lead.email}</td>
                                        <td>${lead.company}</td>
                                        <td>${lead.title}</td>
                                        <td>${lead.type}</td>
                                    </tr>
                                `;
                            }
                        }
                    }
                    // Update the table body with the generated HTML
                    document.getElementById('leadTableBody').innerHTML = leadsTableHTML;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        document.querySelectorAll('.view-campaign').forEach(item => {
            item.addEventListener('click', async function(event) {
                event.preventDefault();
                const campaign = this.getAttribute('id');
        
                // Move the condition inside the click event listener
                if (campaign === 'Django Campaign' || campaign === 'Django Campaign 2') {
                    await handleAddToCampaign(campaign);
                    const dropdownMenu = this.closest('.dropdown-menu');
                    dropdownMenu.classList.remove('show');
                } else {
                    console.log('Invalid campaign selected.');
                }
            });
        });
        
        const viewCampaignDropdown = document.getElementById('viewCampaignDropdown');
        viewCampaignDropdown.addEventListener('click', function(event) {
            event.preventDefault();
            const campaignMenu = document.querySelector('[aria-labelledby="viewCampaignDropdown"]');
            campaignMenu.classList.toggle('show');
        });
        
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                const dropdowns = document.querySelectorAll('.dropdown-menu');
                dropdowns.forEach(dropdown => {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                });
            }
        });
    </script>
{% endblock %}
