<!-- campaign_page.html -->
{% extends 'base.html' %}

{% block title %}
    <title>Campaigns</title>
{% endblock %}

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

{% block content %}
    <form method="post" action="{% url 'delete_selected_leads' %}">
        {% csrf_token %}
        <button class="btn btn-danger float-right mt-3" id="deleteLeadsButton" type="submit">Delete Leads</button>

        <div class="ml-2">
            <!-- Form for selecting a campaign -->
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="viewCampaignDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        View Specific Campaign
                    </button>
                    <div class="dropdown-menu" aria-labelledby="viewCampaignDropdown">
                        <!-- Dynamically populated campaign names -->
                        {% for campaign in distinct_campaigns %}
                            <a class="dropdown-item view-campaign" href="#">{{ campaign }}</a>
                        {% endfor %}
                    </div>
                </div>
                <button class="btn btn-info ml-3" id="viewAllButton">View All Campaigns</button>
            </div>

            <div id="campaignContent" class="mt-3">
                <h2>Leads</h2>
                <div id="campaignEmailsContainer">
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Campaign Name</th>
                            </tr>
                        </thead>
                        <tbody id="campaignEmailsTableBody">
                            <!-- Dynamic content for campaign emails -->
                            {% for email_entry in campaign_emails %}
                                <tr data-campaign="{{ email_entry.campaign_name }}">
                                    <td><input type="checkbox" class="rowCheckbox" name="lead_ids" value="{{ email_entry.id }}"></td>
                                    <td>{{ email_entry.first_name }}</td>
                                    <td>{{ email_entry.last_name }}</td>
                                    <td>{{ email_entry.email }}</td>
                                    <td>{{ email_entry.company }}</td>
                                    <td>{{ email_entry.title }}</td>
                                    <td>{{ email_entry.type }}</td>
                                    <td>{{ email_entry.location }}</td>
                                    <td>{{ email_entry.campaign_name }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="paginationInfo" class="mt-3"></div>
                <button class="btn btn-primary mt-3" id="loadMoreButton">Load More</button>
            </div>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const itemsPerPage = 10;
            let totalEntries = $('#campaignEmailsTableBody tr').length;

            function selectDeselectAll() {
                const selectAllCheckbox = $('#selectAllCheckbox');
                const checkboxes = $('.rowCheckbox');
    
                if (selectAllCheckbox.prop('checked')) {
                    checkboxes.prop('checked', true);
                } else {
                    checkboxes.prop('checked', false);
                }
            }
    
            // Event listener initialization for select/deselect all
            $('#selectAllCheckbox').on('change', function() {
                selectDeselectAll();
            });
                
            function displayPaginationInfo() {
                const startEntry = (currentPage - 1) * itemsPerPage + 1;
                let endEntry = currentPage * itemsPerPage;
                endEntry = endEntry > totalEntries ? totalEntries : endEntry;
                $('#paginationInfo').text(`Displaying ${startEntry}-${endEntry} of ${totalEntries} entries`);
            }

            function showEntries(start, end) {
                $('#campaignEmailsTableBody tr').hide().slice(start, end).show();
                displayPaginationInfo();
            }

            function loadMoreEntries() {
                const start = currentPage * itemsPerPage;
                const end = (currentPage + 1) * itemsPerPage;
                showEntries(0, end);
                currentPage++;
            }

            function initLoadMoreButton() {
                $('#loadMoreButton').on('click', function(event) {
                    event.preventDefault();
                    loadMoreEntries();
                });
                displayPaginationInfo();
            }

            function initEventListeners() {

                $('#viewCampaignDropdown').on('click', function(event) {
                    event.preventDefault();
                    const campaignMenu = $('[aria-labelledby="viewCampaignDropdown"]');
                    if (!$(event.target).hasClass('view-campaign')) {
                        campaignMenu.toggleClass('show');
                    }
                });

                // Event listener for clicking on individual campaigns in dropdown
                $('.view-campaign').on('click', function(event) {
                    event.preventDefault();
                    const campaign = $(this).text();
                    filterCampaignTable(campaign);

                    // Close dropdown after selecting a campaign
                    $('[aria-labelledby="viewCampaignDropdown"]').removeClass('show');
                });

                // Close dropdown if clicked outside of it or on a campaign
                $(document).on('click', function(event) {
                    const dropdownMenu = $('[aria-labelledby="viewCampaignDropdown"]');
                    if (!$(event.target).closest('#viewCampaignDropdown').length) {
                        dropdownMenu.removeClass('show');
                    }
                });

                $('#viewAllButton').on('click', function(event) {
                    event.preventDefault();
                    viewAllCampaigns();
                });

                initLoadMoreButton();

                $('#deleteLeadsButton').on('click', function(event) {
                    event.preventDefault();
                    deleteSelectedLeads();
                });
            }

            initEventListeners();

            // Function to filter the campaign table based on the selected campaign
            function filterCampaignTable(campaignName) {
                $('#campaignEmailsTableBody tr').each(function() {
                    const dataCampaign = $(this).attr('data-campaign');
                    if (dataCampaign === campaignName) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });

                // Update the button text to the selected campaign
                $('#viewCampaignDropdown').text(campaignName);
            }

            // Function to display all campaigns in the table
            function viewAllCampaigns() {
                $('#campaignEmailsTableBody tr').show();

                // Reset button text to default
                $('#viewCampaignDropdown').text('View Specific Campaign');
            }

            // Function to delete selected leads
            function deleteSelectedLeads() {
                const selectedEmails = [];
                let selectedCampaign = '';

                $('#campaignEmailsTableBody input:checked').each(function() {
                    const email = $(this).closest('tr').find('td:nth-child(4)').text().trim();
                    selectedEmails.push(email);

                    selectedCampaign = $(this).closest('tr').find('td:nth-child(9)').text().trim();
                    console.log(selectedCampaign);

                    $(this).closest('tr').remove(); // Remove the row from UI
                });

                // Ask for confirmation before deleting
                const confirmation = confirm('Are you sure you want to delete the selected leads?');
                if (confirmation) {
                    // Send an AJAX request to delete selected leads
                    $.ajax({
                        type: 'POST',
                        url: '{% url "delete_selected_leads" %}',
                        data: JSON.stringify({
                            'delete_list': selectedEmails, // Include the list of selected emails for deletion
                            'campaign_name': selectedCampaign,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        }),
                        contentType: 'application/json',
                        success: function(response) {
                            // Handle success
                            alert('Selected leads deleted successfully');
                            // Update pagination info
                            showEntries(0, end);
                        },
                        error: function(error) {
                            // Handle error
                            console.error('Error deleting leads:', error);
                        }
                    });
                } else {
                    // User clicked cancel, do nothing or perform additional action
                }
            }
        });
    </script>
{% endblock %}
